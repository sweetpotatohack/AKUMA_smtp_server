# Mail Server Setup with DKIM Authentication

Этот проект содержит улучшенные скрипты для настройки почтового сервера с правильной конфигурацией DKIM, SPF и DMARC записей.

## Проблемы, которые были исправлены

### 1. Неправильный селектор DKIM
- **Проблема**: Использовался `default._domainkey.regxa.sbs` вместо `mail._domainkey.regxa.sbs`
- **Решение**: Изменен селектор на `mail` для соответствия A-записи почтового сервера

### 2. Отсутствие SPF записи
- **Проблема**: Не было SPF записи для авторизации отправки писем
- **Решение**: Добавлена SPF запись с правильными параметрами

### 3. Отсутствие DMARC записи
- **Проблема**: Не было DMARC политики для обработки недоставленных писем
- **Решение**: Добавлена DMARC запись с политикой quarantine

### 4. Неправильные права доступа к ключам
- **Проблема**: Приватные ключи DKIM были доступны для чтения другими пользователями
- **Решение**: Установлены правильные права доступа (600) и владелец (opendkim)

## Файлы проекта

### mail_setup_improved.py
Основной скрипт Python для автоматической настройки почтового сервера:
- Установка необходимых пакетов (opendkim, opendkim-tools, postfix)
- Генерация DKIM ключей с правильным селектором
- Настройка OpenDKIM конфигурации
- Настройка Postfix для работы с DKIM
- Вывод DNS записей для добавления в DNS-зону

### setup_mail.sh
Простой bash скрипт для быстрой настройки DKIM ключей

## Использование

### Способ 1: Python скрипт (рекомендуется)

```bash
sudo python3 mail_setup_improved.py regxa.sbs
```

### Способ 2: Bash скрипт

```bash
sudo ./setup_mail.sh
```

## DNS записи для добавления

После выполнения скрипта добавьте следующие DNS записи:

### 1. DKIM запись
```
Имя: mail._domainkey.regxa.sbs
Тип: TXT
Значение: v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
```

### 2. SPF запись
```
Имя: regxa.sbs
Тип: TXT
Значение: v=spf1 a mx include:mail.regxa.sbs ~all
```

### 3. DMARC запись
```
Имя: _dmarc.regxa.sbs
Тип: TXT
Значение: v=DMARC1; p=quarantine; rua=mailto:admin@regxa.sbs
```

## Проверка настроек

После добавления DNS записей и перезапуска сервисов:

```bash
# Перезапустить сервисы
sudo systemctl restart opendkim postfix

# Проверить статус
sudo systemctl status opendkim postfix

# Проверить DNS записи
dig TXT mail._domainkey.regxa.sbs
dig TXT regxa.sbs
dig TXT _dmarc.regxa.sbs
```

## Тестирование отправки писем

Для проверки правильности настройки DKIM используйте:

```bash
# Отправить тестовое письмо
echo "Test email" | mail -s "DKIM Test" test@gmail.com

# Проверить логи
sudo tail -f /var/log/mail.log
```

## Устранение проблем

### Проблема с правами доступа
```bash
sudo chown -R opendkim:opendkim /etc/opendkim/keys/
sudo chmod 600 /etc/opendkim/keys/*/mail.private
```

### Проблема с селектором
Убедитесь, что в файле `/etc/opendkim/KeyTable` используется правильный селектор `mail`, а не `default`.

### Проблема с DNS
Проверьте, что DNS записи добавлены правильно и пропагировались:
```bash
nslookup -type=TXT mail._domainkey.regxa.sbs
```

## Безопасность

1. **Приватные ключи**: Храните приватные ключи DKIM в безопасности с правильными правами доступа
2. **Firewall**: Настройте брандмауэр для защиты почтового сервера
3. **SSL/TLS**: Используйте SSL/TLS сертификаты для шифрования соединений
4. **Регулярные обновления**: Регулярно обновляйте почтовый сервер и операционную систему

## Мониторинг

Для мониторинга DKIM аутентификации используйте:
- DMARC отчеты (настраиваются в rua параметре)
- Логи почтового сервера
- Внешние сервисы для проверки DKIM подписей

## Лицензия

MIT License

## Автор

Создано для решения проблем с аутентификацией почты на домене regxa.sbs
